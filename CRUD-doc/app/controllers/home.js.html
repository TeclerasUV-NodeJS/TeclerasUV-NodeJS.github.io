<!DOCTYPE html>
<html>
<head>
  <title>home.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../", thisFile = "app\\controllers\\home.js", defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>home.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">),</span>
  <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">(),</span>
  <span class="nx">config</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../../config/config&#39;</span><span class="p">),</span>
  <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;crypto&#39;</span><span class="p">),</span>
  <span class="nx">queries</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../queries/index.js&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;body-parser&#39;</span><span class="p">);</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">({</span>
    <span class="nx">extended</span><span class="o">:</span> <span class="kc">false</span>
  <span class="p">}));</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">router</span><span class="p">);</span>

  <span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Esto comprueba que no esté logueado</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">request</span><span class="p">.</span><span class="nx">session</span> <span class="o">!=</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">request</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">name</span> <span class="o">!=</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Si está logueado, manda a menu</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">response</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s2">&quot;menu&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Si no está logueado, manda a loguearse</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">response</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="p">{});</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ruta</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Esto crea una contraseña encriptada de seguridad decente, usando una palabra clave definida en el archivo config/config</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">pass_hasheada</span><span class="o">=</span> <span class="nx">crypto</span>
      <span class="p">.</span><span class="nx">createHmac</span><span class="p">(</span><span class="s2">&quot;sha1&quot;</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">palabra_secreta</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">contrasena</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">digest</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>El radio, según lo que sea, manda a distintas funciones, esto es mucho mejor que copiar el código en el case, no estamos en primer año xD</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">docoest</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s1">&#39;docente&#39;</span><span class="o">:</span>
          <span class="nx">login_docente</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;estudiante&#39;</span><span class="o">:</span>
          <span class="nx">login_estudiante</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="p">}</span>
    <span class="kd">function</span> <span class="nx">login_estudiante</span><span class="p">(){</span>
    <span class="nx">queries</span><span class="p">.</span><span class="nx">login_y_registro</span><span class="p">.</span><span class="nx">buscar_estudiantes</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resultado_estudiantes</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">resultado_estudiantes</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>comprobación que el resultado no sea null y que sea un arreglo no vacío
Recordar que no puedo verificar un método o atributo de un objeto sin antes verificar que el objeto exista, de lo contrario dará error de tipo "no se puede saber length de undefined"</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="nx">resultado_estudiantes</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">resultado_estudiantes</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;no vacio&quot;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">user</span> <span class="k">in</span> <span class="nx">resultado_estudiantes</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">contrasena_bd</span> <span class="o">=</span> <span class="nx">resultado_estudiantes</span><span class="p">[</span><span class="nx">user</span><span class="p">].</span><span class="nx">dataValues</span><span class="p">.</span><span class="nx">EST_PASSWORD</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">resultado_estudiantes</span><span class="p">[</span><span class="nx">user</span><span class="p">].</span><span class="nx">dataValues</span><span class="p">.</span><span class="nx">EST_ID</span> <span class="o">==</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">rut</span> <span class="o">&amp;&amp;</span> <span class="nx">contrasena_bd</span> <span class="o">==</span> <span class="nx">pass_hasheada</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Podría haber usado librerías para sesion, como passport (que entre otras cosas permite conectarse a fb, google, local, y conectar todas las cuentas), pero ni yo ni ustedes teníamos el ánimo de aprender más API's, así que lo hice de la forma más artesanal que pude... escribiendo en las coockies</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">request</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">rut</span><span class="p">;</span>
            <span class="nx">request</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">tipo</span><span class="o">=</span><span class="s2">&quot;estudiante&quot;</span><span class="p">;</span>
            <span class="nx">ruta</span><span class="o">=</span><span class="s2">&quot;/menu&quot;</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>No se debe mandar más de un redirect, aunque creamos que después de redireccionar una vez termina, no es así, y mandará un error de headers (renderizará igual la página, pero con errores), así que por eso, si quieren mandar más de un redirect, hagan lo que hice, cambian la variable de la ruta y al final de todo mandan el redirect. Recordar que no se debe mandar después que termine el callback o no se ejecutará nunca (recordar qué son los callback).</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">response</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="nx">ruta</span><span class="p">);</span>

    <span class="p">})</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">login_docente</span><span class="p">(){</span>
  <span class="nx">queries</span><span class="p">.</span><span class="nx">login_y_registro</span><span class="p">.</span><span class="nx">buscar_docentes</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resultado_docentes</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">resultado_docentes</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">resultado_docentes</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">resultado_docentes</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;no vacio&quot;</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">user</span> <span class="k">in</span> <span class="nx">resultado_docentes</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">contrasena_bd</span> <span class="o">=</span> <span class="nx">resultado_docentes</span><span class="p">[</span><span class="nx">user</span><span class="p">].</span><span class="nx">dataValues</span><span class="p">.</span><span class="nx">DOC_PASSWORD</span><span class="p">;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">resultado_docentes</span><span class="p">[</span><span class="nx">user</span><span class="p">].</span><span class="nx">dataValues</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">resultado_docentes</span><span class="p">[</span><span class="nx">user</span><span class="p">].</span><span class="nx">dataValues</span><span class="p">.</span><span class="nx">DOC_ID</span> <span class="o">==</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">rut</span> <span class="o">&amp;&amp;</span> <span class="nx">contrasena_bd</span> <span class="o">==</span> <span class="nx">pass_hasheada</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">request</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">rut</span><span class="p">;</span>
          <span class="nx">request</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">tipo</span><span class="o">=</span><span class="s2">&quot;docente&quot;</span><span class="p">;</span>
          <span class="nx">ruta</span><span class="o">=</span><span class="s2">&quot;/menu&quot;</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="nx">ruta</span><span class="p">);</span>
  <span class="p">})</span>
<span class="p">}</span>


  <span class="p">});</span>
<span class="p">};</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
